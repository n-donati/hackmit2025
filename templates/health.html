<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Water Health Assessment - Results</title>
<style>
  :root{
    --blue:#0D50CD;
    --blue-700:#0c49bb;
    --ink:#020617;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
    color: var(--ink);
    background:#fff;
    min-height:100vh;
    display:flex;
  }
  .container{
    max-width:390px; width:100%; margin:0 auto; position:relative; background:#fff;
    min-height:100vh; display:flex; flex-direction:column;
  }
  @media (min-width:768px){
    .container{max-width:600px; margin:20px auto; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden}
  }


  .hero{
    position:relative;
    background:var(--blue);
    padding:32px 24px 120px;
    overflow:hidden;
  }
  .hero h1{
    color:#fff; font-weight:800; line-height:1.05;
    font-size:clamp(32px, 8vw, 44px);
    max-width:14ch; position:relative; z-index:1;
  }
  .hero p{
    color:rgba(255,255,255,.85);
    font-size:15px; margin-top:10px; max-width:26ch; font-weight:500;
    position:relative; z-index:1;
  }


  .hero-decor{
    position:absolute; right:-20px; top:-24px;
    width:clamp(180px, 45vw, 280px);
    opacity:.28;
    filter:brightness(0) invert(1); 
    transform:rotate(6deg);
    pointer-events:none; -webkit-user-drag:none; user-select:none;
    z-index:0;
  }

  .score-badge{
    position:absolute; right:28px; top:92px;
    font-size:62px; font-weight:800; color:#fff; letter-spacing:.5px;
    z-index:1;
  }
  @media (max-width: 390px) {
    .score-badge { right:20px; top:80px; font-size:48px; }
    .hero h1 { max-width:12ch; }
    .hero p { max-width:20ch; }
  }
  @media (max-width: 320px) {
    .score-badge { right:16px; top:70px; font-size:40px; }
    .hero h1 { max-width:10ch; }
    .hero p { max-width:18ch; }
  }

  /* white warning pill overlapping hero bottom */
  .warning-card{
    position:relative; z-index:2;
    margin: -44px 24px 18px;
    background:#fff; color:#0b1b39; border-radius:14px;
    padding:14px 16px; display:flex; gap:10px; align-items:flex-start;
    box-shadow:0 8px 18px rgba(13,80,205,.15);
  }
  .warn-icon{
    width:28px; height:28px; display:grid; place-items:center;
    border-radius:8px; background:rgba(13,80,205,.12); flex:0 0 28px;
  }
  .warn-icon img{width:18px; height:18px; filter:invert(20%) sepia(63%) saturate(2913%) hue-rotate(209deg) brightness(94%) contrast(101%); pointer-events:none; -webkit-user-drag:none; user-select:none}
  .warning-card .txt{font-size:13.5px; font-weight:600; line-height:1.35}

  .content{padding:6px 24px 110px; flex:1}


  .dangers{
    color:#fff; border-radius:16px; padding:20px; margin:14px 0 14px;
    position:relative; overflow:hidden;


    background:
      url("../static/images/WavesImage.svg");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  .dangers::before{ content:none; }

  .dangers h2{font-size:20px; font-weight:700; margin-bottom:10px}
  .dangers p{font-size:14px; line-height:1.5; color:rgba(255,255,255,.9); margin-bottom:14px}
  .btn-light{
    background:#fff; color:var(--blue); border:0; border-radius:10px; padding:10px 16px;
    font-weight:700; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
    position:relative; z-index:1;
  }
  .btn-light::after{content:"→"; pointer-events:none}
  .btn-light:hover{background:#f5f7fb}


  .purify{
    background:#fff; border-radius:16px; padding:18px; display:grid; grid-template-columns:1fr 120px; gap:14px;
    border:1px solid rgba(13,80,205,.12);
  }
  .purify h3{font-size:20px; font-weight:800; color:#0b1b39; margin-bottom:6px}
  .purify p{font-size:14px; color:#334155; line-height:1.5; margin-bottom:12px}
  .btn-outline{
    background:#fff; color:var(--blue); border:1px solid rgba(13,80,205,.25);
    border-radius:10px; padding:10px 14px; font-weight:700; font-size:14px; cursor:pointer;
  }
  .btn-outline:hover{background:#f8fafc}
  .purify img{
    width:100%; height:100%; object-fit:cover; border-radius:10px; pointer-events:none; -webkit-user-drag:none; user-select:none
  }


  /* Bottom nav styles centralized in components/navbar.html */


  img, svg{pointer-events:none; -webkit-user-drag:none; user-select:none}
  @media (max-width:390px){ .container{max-width:100%} }
</style>
</head>
<body>
  <div class="container">

    <header class="hero" aria-label="Overview">
      <img class="hero-decor" src="../static/images/Droplet.svg" alt="" aria-hidden="true">
      <h1>Your water’s health</h1>
      <p>Discover your water’s quality, identify risks, and get guidance.</p>
      <div class="score-badge">55%</div>
    </header>


    <section class="warning-card" role="note" aria-live="polite">
      <div class="warn-icon">
        <img src="../static/images/Droplet.svg" alt="Droplet">
      </div>
      <div class="txt" id="warning-text">
        Unsafe to drink; treat before use. Can be used for irrigation, cleaning, or animals after proper treatment.
      </div>
    </section>

    <main class="content">

      <section class="dangers" aria-labelledby="dangers-title">
        <h2 id="dangers-title">Potential Dangers</h2>
        <p id="dangers-text">
          This water may contain bacteria, viruses, heavy metals, or chemical contaminants. Consuming it can lead to gastrointestinal illness, skin irritation, or long-term health issues.
        </p>
        <!-- <button class="btn-light" onclick="learnMore()">Learn more</button> -->
      </section>

  
      <section class="purify" aria-labelledby="irrigation-title">
        <div>
          <h3 id="irrigation-title">Purify Guidance</h3>
          <p id="irrigation-text">Preparing guidance...</p>
          <button class="btn-outline plan-btn" onclick="getDetailedPlan()">Get a detailed plan</button>
        </div>
        <img src="../static/images/irrigation.jpg" alt="Irrigation plants">
      </section>
    </main>


    {% include 'components/navbar.html' with active_tab='results' %}
  </div>

<script>
  (function(){
    try{
      const stored = sessionStorage.getItem('final_result');
      if(!stored){
        console.warn('[HEALTH] No final_result in sessionStorage. Using placeholders.');
        return;
      }
      const data = JSON.parse(stored);
      console.log('[HEALTH] Hydrating with final_result:', data);

      // Pull fields with safeguards
      const score       = data?.water_health_percent ? String(data.water_health_percent) : null;
      const useCases    = data?.current_water_use_cases;
      const dangers     = data?.potential_dangers;
      const purify      = data?.purify_for_selected_use;
      const purifyTitle = data?.purify_title;
      const selectedUse = (data?.selected_use || 'irrigation').toLowerCase();

      // Apply to DOM
      const scoreEl = document.querySelector('.score-badge');
      if (scoreEl && score) scoreEl.textContent = score;

      const warnEl = document.getElementById('warning-text');
      if (warnEl && useCases) warnEl.textContent = useCases;

      const dangerEl = document.getElementById('dangers-text');
      if (dangerEl && dangers) dangerEl.textContent = dangers;

      const titleEl = document.getElementById('irrigation-title');
      const bodyEl  = document.getElementById('irrigation-text');

      const useTitles = {
        drinking: 'Purify for Drinking Use',
        irrigation: 'Purify for Irrigation Use',
        human: 'Purify for Washing Use', // show Washing in UI
        animals: 'Purify for Animal Use'
      };

      if (titleEl) {
        titleEl.textContent = purifyTitle || useTitles[selectedUse] || titleEl.textContent;
      }
      if (bodyEl && purify) {
        bodyEl.textContent = purify;
      }

      // Optional: swap image based on selected use (nice polish)
      const useImages = {
       drinking:  '../static/images/drinkingWater.jpg',
      irrigation:'../static/images/irrigation.jpg',
      human:     '../static/images/washingHands.jpg',
      animals:   '../static/images/animalUse.jpeg'
      };
      const imgEl = document.querySelector('.purify img');
      if (imgEl && useImages[selectedUse]) {
        imgEl.src = useImages[selectedUse];
        imgEl.alt = `${(purifyTitle || useTitles[selectedUse] || 'Purify Guidance')} illustration`;
      }

      // Log exactly what was applied
      console.log('[HEALTH] Applied values:', {
        scoreApplied: scoreEl?.textContent,
        useCasesApplied: warnEl?.textContent,
        dangersApplied: dangerEl?.textContent,
        purifyTitleApplied: titleEl?.textContent,
        purifyBodyApplied: bodyEl?.textContent,
        imageApplied: imgEl?.src,
        selectedUse
      });

      // Expose for buttons
      window.currentChoice = selectedUse;

    } catch (e) {
      console.error('[HEALTH] Error hydrating:', e);
    }
  })();

  // Keep your nav + buttons as-is
  window.navigateTo = function(section, e){
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    if (e && e.currentTarget) e.currentTarget.classList.add('active');
    switch(section){
      case 'home':       window.location.href='home.html'; break;
      case 'analysis':   window.location.href='tester.html'; break;
      case 'results':    window.location.href='water-health.html'; break;
      case 'statistics': window.location.href='statistics.html'; break;
    }
  };

  window.learnMore = function(){
    const label = (window.currentChoice === 'human') ? 'washing' : (window.currentChoice || 'irrigation');
    console.log('[HEALTH] Learn more clicked for:', label);
    // alert(`Learn more about ${label}`);
  };

  window.getDetailedPlan = async function(){
    try{
      const finalStr = sessionStorage.getItem('final_result');
      const analysisStr = sessionStorage.getItem('last_analysis');
      const final_result = finalStr ? JSON.parse(finalStr) : {};
      const analysis = analysisStr ? JSON.parse(analysisStr) : {};
      const res = await fetch('/plan/detailed/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ final_result, analysis })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Failed');
      sessionStorage.setItem('detailed_steps', JSON.stringify(data.steps||[]));
      window.location.href = '/detailed/';
    }catch(e){
      console.error('[HEALTH] detailed plan failed', e);
      alert('Failed to generate detailed plan. Please try again.');
    }
  };
</script>


</body>
</html>

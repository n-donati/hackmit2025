<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Assessment - Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: black;
        }
        
        .container {
            max-width: 390px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: white;
            color: black;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
                margin: 20px auto;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                min-height: calc(100vh - 40px);
            }
        }
        
        .header {
            border-radius: 5px;
            margin: 19px 23px 0;
            padding: 37px 20px 20px;
            position: relative;
            text-align: center;
            overflow: hidden;
            color: black;
        }
        
        .header h1 {
            color: black;
            font-size: clamp(32px, 8vw, 36px);
            font-weight: 600;
            line-height: 1.2;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
            padding-left: 20px;
            padding-right: 20px;
        }
        
        .header p {
            color: rgb(116, 116, 116);
            font-size: clamp(18px, 5vw, 20px);
            font-weight: 500;
            line-height: 1.3;
            position: relative;
            z-index: 2;
            padding-left: 20px;
            padding-right: 20px;
        }
        
        .content {
            padding: 20px 23px;
            flex: 1;
            padding-bottom: 100px;
        }

        .section {
            background-color: #0D50CD;
            border: 1px solid rgba(12.83, 80.45, 205.23, 0.20);
            border-radius: 6px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 2fr 2fr;
            min-height: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            background-color: #0a42a8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 80, 205, 0.3);
        }
        .section:active { transform: scale(0.98); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }
        .section.is-pressed { transform: scale(0.98); box-shadow: 0 6px 14px rgba(0,0,0,0.08); }
        
        .section-header {
            display: flex;
            align-items: start;
            justify-content: space-between;
            padding-left: 20px;
            padding-bottom: 30px;
            padding-top: 30px;
            flex-direction: column;
        }
        
        .section-icon {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .section-icon img {
            position: absolute;
            top: 0;
            right: 0;
            width: 180px;
            height: 240px;
            object-fit: contain;
        }
        
        .section-title {
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            line-height: 1.2;
            padding-bottom: 10px;
        }
        
        .upload-area {
            background: rgba(12.83, 80.45, 205.23, 0.05);
            border: 0.37px solid #0D50CD;
            border-radius: 1.48px;
            padding: 20px;
            text-align: center;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .upload-area:hover {
            background: rgba(12.83, 80.45, 205.23, 0.08);
        }
        
        .upload-icon {
            width: 43px;
            height: 43px;
            background: #0D50CD;
            margin: 0 auto 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-text {
            color: #a9a9a9;
            font-size: 10px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .upload-browse {
            color: #0D50CD;
            font-size: 10px;
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
        }
        
        .section-description {
            color: #bebebe;
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .continue-btn {
            background: #0D50CD;
            border-radius: 10px;
            padding: 12px;
            margin: 20px 23px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .continue-btn:hover {
            background: #0a42a8;
        }
        
        .continue-btn-text {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }
        
        /* Bottom nav styles centralized in components/navbar.html */
        
        @media (max-width: 390px) {
            .container {
                max-width: 100%;
            }
            
            .header {
                margin: 10px 15px 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .continue-btn {
                margin: 15px;
            }
        }
    </style>
    </head>
<body>
    <div class="container">
        <div class="header">
            <h1>What is your objective?</h1>
            <p>Test strips, photos, and location in one flow.</p>
        </div>
        
        <div class="content">
            <div class="section" onclick="selectChoice('drinking')">
                <div class="section-header">
                    <div class="section-title">Drinking</div>
                        <div class="section-description">
                    Determine if the water is safe to drink or cook with.
                </div>
                </div>
                <div>
                    <div class="section-icon">
                        <img src="../static/images/drinking.svg" alt="Drinking" >
                    </div>
                </div>
            </div>
            
            <div class="section" onclick="selectChoice('irrigation')">
                <div class="section-header">
                    <div class="section-title">Irrigation</div>
                        <div class="section-description">
                    Test if it's good for watering plants and crops.
                </div>
                </div>
                <div>
                    <div class="section-icon">
                        <img src="../static/images/irrigation.svg" alt="Irrigation" style="margin-top: -40px;">
                    </div>
                </div>
            </div>
            
            <div class="section" onclick="selectChoice('human')">
                <div class="section-header">
                    <div class="section-title">Hygiene & Cleaning</div>
                        <div class="section-description">
                    See if the water is suitable for showers, bathing, or laundry.
                </div>
                </div>
                <div>
                    <div class="section-icon">
                        <img src="../static/images/bathing.svg" alt="Bathing" style="margin-top: -40px;">
                    </div>
                </div>
            </div>

            <div class="section" onclick="selectChoice('animals')">
                <div class="section-header">
                    <div class="section-title">Animals</div>
                        <div class="section-description">
                    Ensure your water is safe for your pets or farm animals.
                </div>
                </div>
                <div>
                    <div class="section-icon">
                        <img src="../static/images/animals.svg" alt="Animals" >
                    </div>
                </div>
            </div>
        </div>
        
        {% include 'components/navbar.html' with active_tab='analysis' %}
    </div>
    
    <script>
        function navigateTo(section) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            event.target.closest('.nav-item').classList.add('active');
            
            if (section === 'analysis') {
                window.location.href = '/analysis/';
                return;
            }
            console.log('Navigating to:', section);
        }
        
        async function finalizeWith(useCase, btn) {
            try {
                // Press animation feedback
                if (btn) {
                    btn.classList.add('is-pressed');
                }
                // Delay before showing loader
                await new Promise(r => setTimeout(r, 500));

                // Build FormData with files carried from tester
                const fd = new FormData();
                const flow = window.__WATER_FLOW__ || {};
                if (!flow.strip || !flow.water || typeof flow.lat === 'undefined' || typeof flow.lng === 'undefined') {
                    alert('Missing inputs; please go back and upload again.');
                    return;
                }
                fd.append('strip', flow.strip);
                fd.append('waterbody', flow.water);
                fd.append('lat', flow.lat);
                fd.append('lng', flow.lng);
                fd.append('use_case', useCase);

                // Full white overlay with looping droplet fill animation
                const overlay = document.createElement('div');
                overlay.id = 'loaderOverlay';
                overlay.style.position = 'fixed';
                overlay.style.inset = '0';
                overlay.style.background = '#ffffff';
                overlay.style.display = 'flex';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.zIndex = '9999';
                overlay.innerHTML = `
<div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
  <svg width="220" height="280" viewBox="0 0 267.66 332.28" xmlns="http://www.w3.org/2000/svg" aria-label="Loading" style="filter: drop-shadow(0 12px 30px rgba(0,0,0,.12));">
    <defs>
      <clipPath id="logo-clip">
        <path d="M102.73,62.51C56.52,108.91,6.13,176.86,39.06,245.11c36.61,75.87,147.09,77.95,187.43,4.33,35.07-64-6.16-131.87-51.51-177.23-25.54,20.67-49.68,44.17-68.2,71.51-15.66,23.1-30.13,53.59-12.89,80.02,20.87,31.98,72.2,26.59,85.41-9.49,10.71-29.25-7.41-57.53-24.49-79.89l20.24-18.73c16.95,21.16,33.52,48.88,35.2,76.64,4.46,73.67-88.36,111.37-134.8,53.91-31.26-38.68-16.32-82.71,9.07-119.23,24.4-35.11,57.06-64.57,90.79-90.49,26.32,21.97,50.06,48.12,67.48,77.83,31.69,54.05,36.06,116.62-4.38,167.55-58.61,73.83-173.19,65.08-220.48-16.09-27.42-47.06-21.26-99.68,4-145.97C47.53,72.82,88.28,34.98,127.88,0h1.48s22.98,17.97,22.98,17.97c-9.89,8.23-19.92,16.34-29.47,24.98-6.94,6.28-13.56,12.94-20.14,19.55Z"/>
      </clipPath>
    </defs>
    <g clip-path="url(#logo-clip)">
      <!-- Main fill that rises and falls in a loop -->
      <rect id="mainFill" x="0" y="332.28" width="267.66" height="0" fill="#1E5FFF">
        <animate attributeName="y" values="332.28;0;332.28" dur="6s" repeatCount="indefinite" keySplines=".25,.1,.25,1; .25,.1,.25,1" calcMode="spline" />
        <animate attributeName="height" values="0;332.28;0" dur="6s" repeatCount="indefinite" keySplines=".25,.1,.25,1; .25,.1,.25,1" calcMode="spline" />
      </rect>
      
      <!-- Ultra-visible white waves that track the looping fill -->
      <g id="waveSurface">
        <!-- Main ultra-prominent white wave -->
        <path fill="none" stroke="white" stroke-width="12" opacity="1">
          <animate attributeName="d" 
                   values="M 0 0 Q 40 -18 80 0 Q 120 18 160 0 Q 200 -18 240 0 Q 267 18 267 0;
                           M 0 0 Q 40 18 80 0 Q 120 -18 160 0 Q 200 18 240 0 Q 267 -18 267 0;
                           M 0 0 Q 40 0 80 -18 Q 120 0 160 18 Q 200 0 240 -18 Q 267 0 267 0;
                           M 0 0 Q 40 -18 80 0 Q 120 18 160 0 Q 200 -18 240 0 Q 267 18 267 0" 
                   dur="2s" 
                   repeatCount="indefinite" />
        </path>
        
        <!-- Secondary massive white wave -->
        <path fill="none" stroke="white" stroke-width="10" opacity="0.95">
          <animate attributeName="d" 
                   values="M 0 -6 Q 50 -20 100 -6 Q 150 8 200 -6 Q 225 -20 267 -6;
                           M 0 -6 Q 50 8 100 -6 Q 150 -20 200 -6 Q 225 8 267 -6;
                           M 0 -6 Q 50 -6 100 -20 Q 150 -6 200 8 Q 225 -6 267 -6;
                           M 0 -6 Q 50 -20 100 -6 Q 150 8 200 -6 Q 225 -20 267 -6" 
                   dur="1.5s" 
                   repeatCount="indefinite" />
        </path>
        
        <!-- Third bold white wave -->
        <path fill="none" stroke="white" stroke-width="8" opacity="0.9">
          <animate attributeName="d" 
                   values="M 0 4 Q 35 -12 70 4 Q 105 20 140 4 Q 175 -12 210 4 Q 245 20 267 4;
                           M 0 4 Q 35 20 70 4 Q 105 -12 140 4 Q 175 20 210 4 Q 245 -12 267 4;
                           M 0 4 Q 35 4 70 -12 Q 105 4 140 20 Q 175 4 210 -12 Q 245 4 267 4;
                           M 0 4 Q 35 -12 70 4 Q 105 20 140 4 Q 175 -12 210 4 Q 245 20 267 4" 
                   dur="1.8s" 
                   repeatCount="indefinite" />
        </path>
        
        <!-- Fourth accent white wave -->
        <path fill="none" stroke="white" stroke-width="6" opacity="0.85">
          <animate attributeName="d" 
                   values="M 0 -10 Q 30 -25 60 -10 Q 90 5 120 -10 Q 150 -25 180 -10 Q 210 5 240 -10 Q 267 -25 267 -10;
                           M 0 -10 Q 30 5 60 -10 Q 90 -25 120 -10 Q 150 5 180 -10 Q 210 -25 240 -10 Q 267 5 267 -10;
                           M 0 -10 Q 30 -10 60 -25 Q 90 -10 120 5 Q 150 -10 180 -25 Q 210 -10 240 5 Q 267 -10 267 -10;
                           M 0 -10 Q 30 -25 60 -10 Q 90 5 120 -10 Q 150 -25 180 -10 Q 210 5 240 -10 Q 267 -25 267 -10" 
                           dur="1.3s" 
                           repeatCount="indefinite" />
        </path>
        
        <!-- Animate the entire wave group to follow the looping fill -->
        <animateTransform attributeName="transform" 
                          type="translate" 
                          values="0 332.28; 0 0; 0 332.28" 
                          dur="6s" 
                          repeatCount="indefinite" 
                          keySplines=".25,.1,.25,1; .25,.1,.25,1" 
                          calcMode="spline" />
      </g>
    </g>
    <path d="M102.73,62.51C56.52,108.91,6.13,176.86,39.06,245.11c36.61,75.87,147.09,77.95,187.43,4.33,35.07-64-6.16-131.87-51.51-177.23-25.54,20.67-49.68,44.17-68.2,71.51-15.66,23.1-30.13,53.59-12.89,80.02,20.87,31.98,72.2,26.59,85.41-9.49,10.71-29.25-7.41-57.53-24.49-79.89l20.24-18.73c16.95,21.16,33.52,48.88,35.2,76.64,4.46,73.67-88.36,111.37-134.8,53.91-31.26-38.68-16.32-82.71,9.07-119.23,24.4-35.11,57.06-64.57,90.79-90.49,26.32,21.97,50.06,48.12,67.48,77.83,31.69,54.05,36.06,116.62-4.38,167.55-58.61,73.83-173.19,65.08-220.48-16.09-27.42-47.06-21.26-99.68,4-145.97C47.53,72.82,88.28,34.98,127.88,0h1.48s22.98,17.97,22.98,17.97c-9.89,8.23-19.92,16.34-29.47,24.98-6.94,6.28-13.56,12.94-20.14,19.55Z" fill="none" stroke="#0D50CD" stroke-width="3"/>
  </svg>
  <div id="loadingText" style="color: #0D50CD; font-size: 16px; font-weight: 500; text-align: center; margin-top: 10px;">
    Processing test strip image...
  </div>
</div>`;
                document.body.appendChild(overlay);
                
                // Real analysis steps matching the actual app workflow
                const loadingPhrases = [
                    "Processing test strip image...",
                    "Analyzing test strip values...",
                    "Reading chemical indicators...",
                    "Processing water body image...",
                    "Analyzing water body conditions...",
                    "Identifying potential contamination...",
                    "Getting satellite imagery...",
                    "Analyzing location data...",
                    "Examining surrounding environment...",
                    "Compiling final report..."
                ];
                
                let currentPhraseIndex = 0;
                const textElement = document.getElementById('loadingText');
                
                // Function to schedule next phrase change with random timing
                function scheduleNextPhrase() {
                    // Random interval between 1.5 and 3.5 seconds
                    const randomInterval = Math.random() * 2000 + 1500;
                    
                    setTimeout(() => {
                        currentPhraseIndex = currentPhraseIndex + 1;
                        
                        // Stop at the last phrase instead of looping
                        if (currentPhraseIndex < loadingPhrases.length) {
                            textElement.textContent = loadingPhrases[currentPhraseIndex];
                            scheduleNextPhrase(); // Schedule the next change only if not at end
                        }
                    }, randomInterval);
                }
                
                // Start the random phrase cycling
                scheduleNextPhrase();

                const res = await fetch('/aggregate/finalize/', {
                    method: 'POST',
                    body: fd
                });
                const data = await res.json();
                console.log('[FINALIZE] Backend payload from /aggregate/finalize/:', data);

                overlay.remove();
                if (!res.ok) throw new Error(data.error || 'Failed');
                // Pass results to health page
                try {
                    sessionStorage.setItem('final_result', JSON.stringify(data));
                } catch (e) {}
                window.location.href = '/health/?choice=' + encodeURIComponent(useCase);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function selectChoice(choice) {
            const selectedSection = event.target.closest('.section');
            if (selectedSection) {
                selectedSection.classList.add('is-pressed');
            }
            setTimeout(() => finalizeWith(choice, selectedSection), 500);
        }
        
        function continueAssessment() {
            console.log('Continue button clicked');
        }
    </script>
</body>
</html>
